<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AuditVisa · v0.1</title>
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <style>
    :root{ --bg:#0b0c10; --card:#12141a; --muted:#a7b0c0; --fg:#e9eef7; --line:#242a36; }
    html,body{ background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
    .wrap{ max-width: 980px; margin: 28px auto; padding: 0 16px; }
    .top{ display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; }
    .h{ font-size: 22px; margin:0; letter-spacing:.2px; }
    .sub{ color:var(--muted); margin:6px 0 0; font-size: 13px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-top:14px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill{ border:1px solid var(--line); border-radius: 999px; padding:6px 10px; font-size: 12px; color:var(--muted); }
    .pill strong{ color:var(--fg); font-weight:600; }
    .btn{ background:#1a2030; border:1px solid var(--line); color:var(--fg); border-radius:12px; padding:10px 12px; cursor:pointer; font-size: 13px; }
    .btn:hover{ filter:brightness(1.08); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .status{ font-size: 14px; margin-top: 6px; }
    .ok{ color:#8ef0a1; }
    .warn{ color:#ffd479; }
    .fail{ color:#ff8a8a; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ border-top:1px solid var(--line); padding:10px 8px; font-size: 13px; vertical-align:top; }
    th{ text-align:left; color:var(--muted); font-weight:600; }
    code.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .tiny{ color:var(--muted); font-size: 12px; }
    .footer{ color:var(--muted); font-size: 12px; margin-top: 14px; }
    input[type="text"]{ width:min(560px, 100%); background:#0f1117; color:var(--fg); border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:13px; }
    .hint{ color:var(--muted); font-size: 12px; margin-top:6px; line-height:1.45; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="h">AuditVisa <span class="tiny">v1.0</span></h1>
        <div class="sub">Worker-proxied audit runner · produces VisaID and evidence table</div>
      </div>
      <div class="row">
        <button class="btn" id="runBtn">Run audit</button>
        <span class="pill">Policy: <strong>AuditVisa v1.0</strong></span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="tiny">Target origin</div>
          <div class="row" style="margin-top:6px;">
            <input id="originInput" type="text" spellcheck="false" />
            <button class="btn" id="sameBtn" title="Use same origin">Same-origin</button>
          </div>
          <div class="hint">
            This page calls <code class="mono">/api/visa?target=…</code> (Worker) to avoid CORS.
            “Same-origin” sets <code class="mono">location.origin</code>. Paste a domain or full URL in the box.
          </div>
        </div>
        <div>
          <div class="tiny">VisaID</div>
          <div class="pill"><code class="mono" id="visaId">—</code></div>
        </div>
      </div>

      <div class="status" id="headline">Idle.</div>
      <div class="tiny" id="summary">Checks: — · PASS — · WARN — · FAIL —</div>

      <table>
        <thead>
          <tr>
            <th style="width:92px;">Status</th>
            <th style="width:190px;">Check</th>
            <th>Path</th>
            <th style="width:240px;">Evidence</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

<div id="printStamp" class="tiny" style="margin-top:12px; opacity:.7;">
Issued by: aiorigins.org · Policy: AuditVisa v1.0 · VisaID(full): —
</div>
      
      <div class="footer">
        EN: Critical checks must PASS. Any FAIL ⇒ Visa rejected.<br/>
        中文：必检项必须通过。存在 FAIL ⇒ 拒签。
      </div>
    </div>
  </div>

<script>
(function(){
  // c:true => critical (FAIL rejects visa)
  // c:false => optional (missing => WARN)
  const checks = [
    { key:"node.json",        path:"/.well-known/node.json",        critical:true,  expect:"json" },
    { key:"portal.json",      path:"/portal/portal.json",           critical:true,  expect:"json" },
    { key:"manifest.json",    path:"/agent/manifest.json",          critical:true,  expect:"json" },
    { key:"protocol.json",    path:"/agent/protocol.json",          critical:true,  expect:"json" },
    { key:"access-policy",    path:"/agent/access-policy.json",     critical:true,  expect:"json" },
    { key:"capability-map",   path:"/agent/capability-map.json",    critical:true,  expect:"json" },

    // optional
    { key:"registry.json",    path:"/agent/registry.json",          critical:false, expect:"json" },
    { key:"checksums.json",   path:"/node/checksums.json",          critical:false, expect:"json" }
  ];

  const $ = (id)=>document.getElementById(id);
  const runBtn = $("runBtn");
  const sameBtn = $("sameBtn");
  const originInput = $("originInput");
  const rows = $("rows");
  const headline = $("headline");
  const summary = $("summary");
  const visaIdEl = $("visaId");

  // Default: keep current behavior (same origin of this page)
  originInput.value = location.origin;

  sameBtn.addEventListener("click", ()=>{
    originInput.value = location.origin;
  });

  runBtn.addEventListener("click", run);

  function esc(s){
    return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function setHeadline(type, text){
    headline.className = "status " + (type || "");
    headline.textContent = text;
  }

  function addRow(status, check, path, evidence){
    const tr = document.createElement("tr");
    const sClass = status === "PASS" ? "ok" : (status === "WARN" ? "warn" : "fail");
    tr.innerHTML = `
      <td class="${sClass}"><strong>${esc(status)}</strong></td>
      <td>${esc(check)}</td>
      <td><code class="mono">${esc(path)}</code></td>
      <td>${evidence}</td>
    `;
    rows.appendChild(tr);
  }

  function normalizeOrigin(o){
    o = (o || "").trim();
    if(!o) return location.origin;
    // allow user to paste full url; keep scheme+host+port only
    try{
      const u = new URL(o);
      return u.origin;
    }catch(e){
      // if user pasted origin without scheme, attempt https
      try{
        const u2 = new URL("https://" + o.replace(/^\/+/, ""));
        return u2.origin;
      }catch(e2){
        return location.origin;
      }
    }
  }

  function statusToClass(s){
    if(s === "PASS") return "ok";
    if(s === "WARN") return "warn";
    return "fail";
  }

  function normalizeStatus(s){
    s = String(s || "").toUpperCase().trim();
    if(s === "OK" || s === "GRANTED" || s === "ALLOW") return "PASS";
    if(s === "WARNING") return "WARN";
    if(s === "FAIL" || s === "REJECTED" || s === "DENY" || s === "BLOCK") return "FAIL";
    if(s === "PASS" || s === "WARN") return s;
    return "FAIL";
  }

  function pick(obj, keys, fallback){
    for(const k of keys){
      if(obj && obj[k] != null) return obj[k];
    }
    return fallback;
  }

function renderFromWorker(origin, data){
    // VisaID
    const vidShort = pick(data, ["visa_id","visaId","visa","id"], "");
    const vidFull  = pick(data, ["visa_id_full","visaFull","full_id"], vidShort);

    visaIdEl.textContent = vidShort
        ? (String(vidShort).length > 13 ? String(vidShort).slice(0,12) + "…" : String(vidShort))
        : "—";

    // ⭐ 保存完整 VisaID（不显示）
    visaIdEl.dataset.full = vidFull || "";

    // ⭐ 点击复制完整 ID
    visaIdEl.style.cursor = "pointer";
    visaIdEl.title = "Click to copy full VisaID";
    visaIdEl.onclick = async ()=>{
        try{
            await navigator.clipboard.writeText(visaIdEl.dataset.full || "");
            visaIdEl.style.opacity = "0.6";
            setTimeout(()=>visaIdEl.style.opacity="1", 250);
        }catch(e){}
    };

const stamp = document.getElementById("printStamp");
if(stamp){
  stamp.textContent =
    "Issued by: aiorigins.org · Policy: AuditVisa v1.0 · VisaID(full): " +
    (vidFull || "—");
}
  
    // counts
    const counts = data && data.counts ? data.counts : null;
    let pass = Number(pick(counts, ["pass"], NaN));
    let warn = Number(pick(counts, ["warn"], NaN));
    let fail = Number(pick(counts, ["fail"], NaN));
    let total = Number(pick(counts, ["checks","total"], NaN));

    // If counts missing, infer from table
    const table = Array.isArray(data && data.table) ? data.table
                : (Array.isArray(data && data.results) ? data.results
                : (Array.isArray(data && data.evidence) ? data.evidence : []));

    if(!Number.isFinite(total)) total = checks.length;
    if(!Number.isFinite(pass) || !Number.isFinite(warn) || !Number.isFinite(fail)){
      pass = 0; warn = 0; fail = 0;
      for(const r of table){
        const s = normalizeStatus(pick(r, ["status"], "FAIL"));
        if(s === "PASS") pass++;
        else if(s === "WARN") warn++;
        else fail++;
      }
    }

    summary.textContent = `Checks: ${total} · PASS ${pass} · WARN ${warn} · FAIL ${fail}`;

    // verdict
    const verdictRaw = String(pick(data, ["verdict","decision","status"], "")).toUpperCase();
    const verdict = verdictRaw || (fail > 0 ? "REJECTED" : (warn > 0 ? "WARN" : "GRANTED"));

    if(verdict === "GRANTED" || verdict === "PASS"){
      setHeadline("ok", `PASS ✔  EN: All critical checks passed. Visa granted.  中文：必检项全部通过，签证通过。`);
    }else if(verdict === "WARN" || verdict === "WARNING"){
      setHeadline("warn", `WARN ⚠  EN: Critical checks passed; optional warnings exist.  中文：必检项通过，但存在可选项警告。`);
    }else{
      setHeadline("fail", `FAIL ✘  EN: One or more critical checks failed. Visa rejected.  中文：存在必检项失败，签证拒签。`);
    }

    // rows
    rows.innerHTML = "";
    if(table.length){
      for(const r of table){
        const s = normalizeStatus(pick(r, ["status"], "FAIL"));
        const check = String(pick(r, ["check","key","name"], "—"));
        const path = String(pick(r, ["path"], "—"));

        const http = pick(r, ["http","status_code"], null);
        const ms = pick(r, ["ms","latency_ms","time_ms"], null);
        const ct = pick(r, ["content_type","contentType","ct"], null);
        const note = String(pick(r, ["evidence","note","message"], ""));

        const url = String(pick(r, ["url"], origin + path));

        const parts = [];
        if(note) parts.push(note);
        else{
          const p2 = [];
          if(http != null) p2.push("HTTP " + http);
          if(ct) p2.push(String(ct));
          if(ms != null) p2.push(String(ms) + "ms");
          parts.push(p2.join(" · ") || "—");
        }

        const evHtml = `
          <div class="tiny">
            <div><strong>${esc(parts.join(" · "))}</strong></div>
            <div>URL: <code class="mono">${esc(url)}</code></div>
          </div>
        `;
        addRow(s, check, path, evHtml);
      }
      return;
    }

    // Fallback: show expected checks with “no table”
    for(const c of checks){
      addRow("WARN", c.key, c.path, `<div class="tiny"><strong>No evidence table returned</strong></div>`);
    }
  }

  async function runViaWorker(origin){
    const url = `/api/visa?target=${encodeURIComponent(origin)}`;
    const started = Date.now();
    const r = await fetch(url, { method:"GET", cache:"no-store" });
    const ms = Date.now() - started;

    let txt = "";
    try{ txt = await r.text(); }catch(e){}

    if(!r.ok){
      // try to show any JSON error
      let msg = `HTTP ${r.status}`;
      try{
        const j = JSON.parse(txt);
        msg = String(pick(j, ["error","message"], msg));
      }catch(e){}
      const err = new Error(msg);
      err.http = r.status;
      err.ms = ms;
      err.url = url;
      throw err;
    }

    try{
      return JSON.parse(txt);
    }catch(e){
      const err = new Error("Invalid JSON from Worker");
      err.http = r.status;
      err.ms = ms;
      err.url = url;
      throw err;
    }
  }

  async function run(){
    runBtn.disabled = true;
    rows.innerHTML = "";
    visaIdEl.textContent = "—";
    setHeadline("", "Running…");

    const origin = normalizeOrigin(originInput.value);

    try{
      const data = await runViaWorker(origin);
      renderFromWorker(origin, data);
    }catch(err){
      setHeadline("fail", `FAIL ✘  EN: Audit runner error.  中文：审计执行失败。`);
      summary.textContent = `Checks: — · PASS — · WARN — · FAIL —`;

      const evHtml = `
        <div class="tiny">
          <div><strong>${esc(err && err.message ? err.message : "Unknown error")}</strong></div>
          <div>Endpoint: <code class="mono">/api/visa</code></div>
        </div>
      `;

      // show a single row as evidence
      rows.innerHTML = "";
      addRow("FAIL", "worker", "/api/visa?target=…", evHtml);
    }finally{
      runBtn.disabled = false;
    }
  }
})();
</script>
</body>
</html>
