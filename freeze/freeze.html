<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>sa_economy · Freeze Console</title>
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <style>
    body{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; max-width:980px; margin:40px auto; padding:0 16px;}
    h1{font-size:18px;margin:0 0 12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0;}
    input{padding:8px 10px; border:1px solid #ddd; border-radius:10px; min-width:260px;}
    button{padding:8px 12px; border:1px solid #ddd; border-radius:12px; background:#fff; cursor:pointer;}
    button:hover{border-color:#999;}
    pre{background:#0b0b0b; color:#e9e9e9; padding:14px; border-radius:14px; overflow:auto; min-height:220px;}
    .hint{opacity:.7; font-size:12px;}
    .ok{color:#0a0;}
    .bad{color:#c00;}
  </style>
</head>
<body>
  <h1>sa_economy · Freeze Console</h1>
  <div class="hint">RPC: <span id="rpcUrl"></span></div>

  <div class="row">
    <input id="caseId" placeholder="case_id (e.g. case3)" value="case3" />
    <button onclick="statusAll()">status_all</button>
    <button onclick="statusOne()">status</button>
    <button onclick="freeze()">ops_freeze</button>
    <button onclick="unfreeze()">ops_unfreeze</button>
  </div>

  <div class="row">
    <input id="opsHash" placeholder="ops_hash" />
    <button onclick="getAction()">ops_action_get</button>
    <button onclick="verifyOps()">verify_ops</button>
  </div>

  <pre id="out">{ ready }</pre>

<script>
  const RPC = "https://rpc.evanbei.com/agent/rpc";
  document.getElementById("rpcUrl").textContent = RPC;

function pickHashFromPending(p) {
  // 支持两种结构：result 是数组 或 包一层
  const list = Array.isArray(p?.result) ? p.result : (p?.result?.items || []);
  const first = list && list.length ? list[0] : null;
  const h = first?.ops_hash;
  if (h) document.getElementById("opsHash").value = h;
  return h;
}

async function pendingFillFirst() {
  const p = await call("ops_pending_list");
  show(p);
  pickHashFromPending(p);
}

// 页面打开就跑一次
pendingFillFirst();  
 async function pending() {
  show(await call("ops_pending_list"));
}
  
  async function call(method, params = undefined) {
    const payload = { method, id: Date.now() };
    if (params) payload.params = params;

    const res = await fetch(RPC, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload),
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { http_status: res.status, raw: text }; }

    if (!res.ok) {
      // keep both HTTP status + json error
      data.http_status = res.status;
    }
    return data;
  }

  async function statusAll() {
    show(await call("status_all"));
  }
  async function statusOne() {
    const case_id = document.getElementById("caseId").value.trim();
    show(await call("status", { case_id }));
  }
  async function freeze() {
    const case_id = document.getElementById("caseId").value.trim();
    const r = await call("ops_freeze", { case_id });
    show(r);
    // convenience: auto-fill ops_hash
    const h = r?.result?.ops_hash;
    if (h) document.getElementById("opsHash").value = h;
  }
  async function unfreeze() {
    const case_id = document.getElementById("caseId").value.trim();
    const r = await call("ops_unfreeze", { case_id });
    show(r);
    const h = r?.result?.ops_hash;
    if (h) document.getElementById("opsHash").value = h;
  }
  async function getAction() {
    const hash = document.getElementById("opsHash").value.trim();
    show(await call("ops_action_get", { hash }));
  }
  async function verifyOps() {
    const hash = document.getElementById("opsHash").value.trim();
    show(await call("verify_ops", { hash }));
  }
</script>
</body>
</html>
